<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebUI - Hacker News Stories</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: #ff6600;
        }

        .status {
            font-size: 0.85rem;
            color: #666;
        }

        .status.error {
            color: #d32f2f;
        }

        button {
            padding: 8px 16px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        button.primary {
            background: #ff6600;
            color: white;
        }

        button.primary:hover {
            background: #e55c00;
        }

        button.secondary {
            background: #e0e0e0;
            color: #333;
        }

        button.secondary:hover {
            background: #d0d0d0;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .controls {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .controls-header h2 {
            margin: 0;
            font-size: 1rem;
            color: #666;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: #555;
        }

        .filter-group input, .filter-group select {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #ff6600;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
        }

        .range-inputs input {
            flex: 1;
            min-width: 0;
        }

        .sort-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }

        .sort-row .filter-group {
            flex: 1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
        }

        th {
            background: #f8f8f8;
            font-weight: 600;
            color: #555;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:not(:last-child) td {
            border-bottom: 1px solid #eee;
        }

        tr:hover td {
            background: #fafafa;
        }

        td.rank {
            font-weight: 600;
            color: #888;
            width: 50px;
        }

        td.headline {
            max-width: 500px;
        }

        td.headline a {
            color: #333;
            text-decoration: none;
        }

        td.headline a:hover {
            color: #ff6600;
        }

        td.headline .domain {
            font-size: 0.8rem;
            color: #888;
            margin-left: 5px;
        }

        td.numeric {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        td.comments a {
            color: #666;
            text-decoration: none;
        }

        td.comments a:hover {
            color: #ff6600;
        }

        td.username {
            color: #666;
        }

        td.age {
            color: #888;
            white-space: nowrap;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }

            table {
                font-size: 0.9rem;
            }

            th, td {
                padding: 10px;
            }

            td.headline {
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <h1>Hacker News Stories</h1>
            <div class="status" id="status">Loading...</div>
        </div>
        <button class="primary" id="refreshBtn" onclick="refreshData()">Refresh Data</button>
    </header>

    <div class="controls">
        <div class="controls-header">
            <h2>Filters</h2>
            <button class="secondary" onclick="clearFilters()">Clear Filters</button>
        </div>
        <div class="filter-grid">
            <div class="filter-group">
                <label for="headline">Headline (fuzzy match)</label>
                <input type="text" id="headline" placeholder="Search headlines...">
            </div>
            <div class="filter-group">
                <label for="username">Username (fuzzy match)</label>
                <input type="text" id="username" placeholder="Filter by username...">
            </div>
            <div class="filter-group">
                <label for="url">URL (fuzzy match)</label>
                <input type="text" id="url" placeholder="Filter by URL...">
            </div>
            <div class="filter-group">
                <label>Points Range</label>
                <div class="range-inputs">
                    <input type="number" id="pointsMin" placeholder="Min">
                    <input type="number" id="pointsMax" placeholder="Max">
                </div>
            </div>
            <div class="filter-group">
                <label>Comments Range</label>
                <div class="range-inputs">
                    <input type="number" id="commentsMin" placeholder="Min">
                    <input type="number" id="commentsMax" placeholder="Max">
                </div>
            </div>
            <div class="filter-group">
                <label>Rank Range</label>
                <div class="range-inputs">
                    <input type="number" id="rankMin" placeholder="Min">
                    <input type="number" id="rankMax" placeholder="Max">
                </div>
            </div>
            <div class="filter-group">
                <label>Page Range</label>
                <div class="range-inputs">
                    <input type="number" id="pageMin" placeholder="Min">
                    <input type="number" id="pageMax" placeholder="Max">
                </div>
            </div>
            <div class="filter-group">
                <label>Age Range</label>
                <div class="range-inputs">
                    <input type="number" id="ageMin" placeholder="Min">
                    <input type="number" id="ageMax" placeholder="Max">
                    <select id="ageUnit">
                        <option value="hours">hours</option>
                        <option value="minutes">minutes</option>
                        <option value="days">days</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="sort-row">
            <div class="filter-group">
                <label for="sortField">Sort By</label>
                <select id="sortField">
                    <option value="">-- None --</option>
                    <option value="rank">Rank</option>
                    <option value="points">Points</option>
                    <option value="comments">Comments</option>
                    <option value="age">Age</option>
                    <option value="headline">Headline</option>
                    <option value="username">Username</option>
                    <option value="page">Page</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortDirection">Direction</label>
                <select id="sortDirection">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
            </div>
            <button class="primary" onclick="applyFilters()">Apply Filters</button>
        </div>
    </div>

    <div id="tableContainer">
        <div class="empty-state">Loading stories...</div>
    </div>

    <script>
        let currentData = null;

        document.addEventListener('DOMContentLoaded', function() {
            fetchStories();
        });

        function buildQueryBody() {
            const body = {};
            const filters = {};

            // Fuzzy match filters
            const headline = document.getElementById('headline').value.trim();
            if (headline) {
                filters.headline = { match: headline };
            }

            const username = document.getElementById('username').value.trim();
            if (username) {
                filters.username = { match: username };
            }

            const url = document.getElementById('url').value.trim();
            if (url) {
                filters.url = { match: url };
            }

            // Range filters
            const pointsMin = document.getElementById('pointsMin').value;
            const pointsMax = document.getElementById('pointsMax').value;
            if (pointsMin || pointsMax) {
                filters.points = {};
                if (pointsMin) filters.points.min = parseInt(pointsMin);
                if (pointsMax) filters.points.max = parseInt(pointsMax);
            }

            const commentsMin = document.getElementById('commentsMin').value;
            const commentsMax = document.getElementById('commentsMax').value;
            if (commentsMin || commentsMax) {
                filters.comments = {};
                if (commentsMin) filters.comments.min = parseInt(commentsMin);
                if (commentsMax) filters.comments.max = parseInt(commentsMax);
            }

            const rankMin = document.getElementById('rankMin').value;
            const rankMax = document.getElementById('rankMax').value;
            if (rankMin || rankMax) {
                filters.rank = {};
                if (rankMin) filters.rank.min = parseInt(rankMin);
                if (rankMax) filters.rank.max = parseInt(rankMax);
            }

            const pageMin = document.getElementById('pageMin').value;
            const pageMax = document.getElementById('pageMax').value;
            if (pageMin || pageMax) {
                filters.page = {};
                if (pageMin) filters.page.min = parseInt(pageMin);
                if (pageMax) filters.page.max = parseInt(pageMax);
            }

            // Age filter
            const ageMin = document.getElementById('ageMin').value;
            const ageMax = document.getElementById('ageMax').value;
            if (ageMin || ageMax) {
                filters.age = {
                    unit: document.getElementById('ageUnit').value
                };
                if (ageMin) filters.age.min = parseInt(ageMin);
                if (ageMax) filters.age.max = parseInt(ageMax);
            }

            if (Object.keys(filters).length > 0) {
                body.filters = filters;
            }

            // Sort
            const sortField = document.getElementById('sortField').value;
            if (sortField) {
                body.sort = [{
                    field: sortField,
                    direction: document.getElementById('sortDirection').value
                }];
            }

            return body;
        }

        async function fetchStories() {
            const tableContainer = document.getElementById('tableContainer');
            const status = document.getElementById('status');

            tableContainer.classList.add('loading');
            status.textContent = 'Loading...';
            status.classList.remove('error');

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(buildQueryBody())
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch stories');
                }

                currentData = data;
                renderStories(data);
                updateStatus(data);
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                status.classList.add('error');
                tableContainer.innerHTML = '<div class="empty-state">Failed to load stories. Is the Querier running?</div>';
            } finally {
                tableContainer.classList.remove('loading');
            }
        }

        async function refreshData() {
            const refreshBtn = document.getElementById('refreshBtn');
            const status = document.getElementById('status');

            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Refreshing...';
            status.textContent = 'Refreshing data from source...';
            status.classList.remove('error');

            try {
                const response = await fetch('/api/refresh', {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to refresh data');
                }

                // Now fetch the stories with current filters
                await fetchStories();
            } catch (err) {
                status.textContent = 'Error: ' + err.message;
                status.classList.add('error');
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.textContent = 'Refresh Data';
            }
        }

        function applyFilters() {
            fetchStories();
        }

        function clearFilters() {
            document.getElementById('headline').value = '';
            document.getElementById('username').value = '';
            document.getElementById('url').value = '';
            document.getElementById('pointsMin').value = '';
            document.getElementById('pointsMax').value = '';
            document.getElementById('commentsMin').value = '';
            document.getElementById('commentsMax').value = '';
            document.getElementById('rankMin').value = '';
            document.getElementById('rankMax').value = '';
            document.getElementById('pageMin').value = '';
            document.getElementById('pageMax').value = '';
            document.getElementById('ageMin').value = '';
            document.getElementById('ageMax').value = '';
            document.getElementById('ageUnit').value = 'hours';
            document.getElementById('sortField').value = '';
            document.getElementById('sortDirection').value = 'asc';
            fetchStories();
        }

        function updateStatus(data) {
            const status = document.getElementById('status');
            const fetchedAt = new Date(data.fetched_at).toLocaleString();
            status.textContent = `${data.count} stories | Data from: ${fetchedAt}`;
            status.classList.remove('error');
        }

        function extractDomain(url) {
            if (!url) return '';
            try {
                const hostname = new URL(url).hostname;
                return hostname.replace(/^www\./, '');
            } catch {
                return '';
            }
        }

        function renderStories(data) {
            const container = document.getElementById('tableContainer');

            if (!data.stories || data.stories.length === 0) {
                container.innerHTML = '<div class="empty-state">No stories match your filters.</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Headline</th>
                            <th>Points</th>
                            <th>Comments</th>
                            <th>User</th>
                            <th>Age</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            for (const story of data.stories) {
                const domain = extractDomain(story.url);
                const domainHtml = domain ? `<span class="domain">(${domain})</span>` : '';
                const headlineLink = story.url
                    ? `<a href="${escapeHtml(story.url)}" target="_blank" rel="noopener">${escapeHtml(story.headline)}</a>`
                    : escapeHtml(story.headline);

                html += `
                    <tr>
                        <td class="rank">${story.rank}</td>
                        <td class="headline">${headlineLink}${domainHtml}</td>
                        <td class="numeric">${story.points}</td>
                        <td class="numeric comments">
                            <a href="${escapeHtml(story.discussion_url)}" target="_blank" rel="noopener">${story.comments}</a>
                        </td>
                        <td class="username">${escapeHtml(story.username)}</td>
                        <td class="age">${story.age_value} ${story.age_unit}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
